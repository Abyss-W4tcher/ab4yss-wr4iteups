ARG PHP_VERSION=XX

FROM php:${PHP_VERSION}

RUN apt update -y

# PHP dependencies + utilities
RUN apt install -y libcurl3-dev \
    libxml2-dev \
    libmemcached-dev \
    libz-dev \
    libpq-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libssl-dev \
    libwebp-dev \
    libxpm-dev \
    libmcrypt-dev \
    libonig-dev \
    libzip-dev \
    libsodium-dev \
    wget \
    zip \
    default-mysql-client

# PHP gd extensions
RUN docker-php-ext-configure gd \
    --prefix=/usr \
    --with-jpeg \
    --with-webp \
    --with-xpm \
    --with-freetype 

# PHP modules
RUN docker-php-ext-install \
    sodium \
    phar \
    curl \
    xml \
    gd \
    zip \
    mysqli 

WORKDIR /var/www/html

# spip_loader
RUN wget https://get.spip.net/spip_loader.php \
    && mv spip_loader.php spip_loader.phar \
    && php -r '$phar = new Phar("spip_loader.phar");$phar->extractTo(".");' \
    && mv index.php spip_loader.php \
    && sed -i 's/index.php/spip_loader.php/g' spip_loader.php

ENTRYPOINT php -S 0.0.0.0:80